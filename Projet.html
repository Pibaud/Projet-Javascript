<!DOCTYPE html>
<html lang="fr">
  <head>
      <title>Le Jeu de la Vie</title>
      <link rel="stylesheet" href="/public/style.css">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
      <script src="https://d3js.org/d3.v5.min.js"></script> 
      <script src="/socket.io/socket.io.js"></script>
      <script> var socket = io(); </script>
      <script>

         var nbLignes = nbColonnes = 11;
         var rayon = 35;
         var numJoueur = -1;
         const nbMaxJoueurs = 4;

         function creerLaPartie(){
            let nom = document.getElementById("nom").value;
            let nbJoueurs = parseInt(document.getElementById("nbJoueurs").value,10);
            let nbTours = parseInt(document.getElementById("nbTours").value,10);
            let reproduction = parseInt(document.getElementById("reproduction").value,10);
            let perception = parseInt(document.getElementById("perception").value,10);
            let force = parseInt(document.getElementById("force").value,10);
            if (nom != "" && nom != " " && (reproduction + perception + force) <= 9){
               $("#creerLaPartie").css("display","none");
               $("#entrerDansLaPartie").css("display","none");
               $("#quitterLaPartie").css("display","inline");
               $("#tousRépartis").css("display","none");
               socket.emit('creation', {'nom':nom, 'nbJoueurs':nbJoueurs, 'nbTours':nbTours, 'reproduction':reproduction, 'perception':perception, 'force':force});
            }
            else{
               $("#tousRépartis").css("display","inline");
            }
         }

         function entrerDansLaPartie() {  
            let nom = document.getElementById("nom").value;
            let reproduction = parseInt(document.getElementById("reproduction").value,10);
            let perception = parseInt(document.getElementById("perception").value,10);
            let force = parseInt(document.getElementById("force").value,10);
            if (nom != "" && nom != " "){
               $("#quitterLaPartie").css("display","inline");
               $("#entrerDansLaPartie").css("display","none");
               socket.emit('entree', {'nom':nom, 'reproduction':reproduction, 'perception':perception, 'force':force});
            }
         }

         function quitterLaPartie() {
            let nom = document.getElementById("nom").value;
            console.log("Sortie de "+nom);
           
            if (nom != "" && nom != " ") socket.emit('sortie', nom);
         }

         function creePointsHexagone(rayon) { // Calcul des coordonnées des six points d'un hexagone
            var points = new Array();
            for (var i = 0; i < 6; ++i) {
                  var angle = i * Math.PI / 3;
                  var x = Math.sin(angle) * rayon;
                  var y = -Math.cos(angle) * rayon;
                  points.push([Math.round(x*100)/100, Math.round(y*100)/100]);
            }
            return points;
         }

         function genereTerrain(rayon, nbLignes, nbColonnes) {
            let distance =  rayon - (Math.sin(1 * Math.PI / 3) * rayon); // distance entre deux hexagones

            d3.select("#tablier").append("svg").attr("id","svgTablier").attr("width", nbColonnes*1.33*2*rayon).attr("height",nbLignes*2*rayon);
            let hexagone = creePointsHexagone(rayon);
            for (let ligne=0; ligne < nbLignes; ligne++) {
               for (let colonne=0; colonne < nbColonnes; colonne++) {
                  let d = "", x, y;
                  for (h in hexagone) {
                     x = hexagone[h][0]+(rayon-distance)*(2+ligne+2*colonne);
                     y = distance*2 + hexagone[h][1]+(rayon-distance*2)*(1+2*ligne);
                     if (h == 0) d += "M"+x+","+y+" L";
                     else        d +=     x+","+y+" ";
                  }
                  console.log("h"+(ligne*nbLignes+colonne));
                  d += "Z";
                  d3.select("#svgTablier")
                     .append("path")
                     .attr("d", d)
                     .attr("stroke", "black")
                     .attr("fill", "white")
                     .attr("class", "hexagoneDamier")
                     .attr("id", "h"+(ligne*nbLignes+colonne)) // car un id doit commencer par une lettre
               }
            }
         }
         
         function colorationTerrain(joueurs){
            let nbEspèces = joueurs.length;
            if(nbEspèces >= 1){
               d3.select("h55").attr("fill",joueurs[0].couleur);
            }
            if(nbEspèces >= 2){
               d3.select("h65").attr("fill",joueurs[1].couleur);
            }
            if(nbEspèces >= 3){
               d3.select("h115").attr("fill",joueurs[2].couleur);
            }
            if(nbEspèces == 4){
               d3.select("h5").attr("fill",joueurs[3].couleur);
            }
         }

         window.addEventListener('load', (event) => {
            $("#tousRépartis").css("display","none");
            console.log("demande de joueurs ...");
            socket.emit('demandeNbJoueurs');
            genereTerrain(rayon, nbLignes, nbColonnes);
            document.getElementById("tablier").style.display = "none";
         });
         
         socket.on('creation',data => {
            $("#creerLaPartie").css("display","none");
            $("#quitterLaPartie").css("display","none");
            $("#entrerDansLaPartie").css("display","inline");
            $("#infosCreateur").css("display","none");
         });
         
         socket.on('joueurs', nomsJoueurs => {
            console.log("joueurs reçus du serveur : ");
            console.dir(nomsJoueurs);
            $("#listeJoueurs").text(nomsJoueurs);
         });

         socket.on('nbJoueurs',data =>{
            console.log("joueurs reçus :");
            console.dir(data);
            if(data.nbActuel > 0){
               $("#creerLaPartie").css("display","none");
               $("#quitterLaPartie").css("display","none");
               $("#entrerDansLaPartie").css("display","inline");
               $("#infosCreateur").css("display","none");
            }
            else{
               $("#creerLaPartie").css("display","inline");
               $("#quitterLaPartie").css("display","none");
               $("#entrerDansLaPartie").css("display","none");
            }
         });

         socket.on('entree', data => {
            numJoueur = data.numJoueur;
            console.log("Le serveur confirme mon entrée avec numJoueur="+numJoueur);
            $("#listeJoueurs").text(data.nomsJoueurs);
         });

         socket.on('entreeAutreJoueur', data => {
            console.log("Le serveur confirme l'entrée de "+data.nomJoueur);
            $("#listeJoueurs").text(data.nomsJoueurs);
         });

         socket.on('sortie', data => {
            console.log("Le serveur confirme ma sortie");
            numJoueur = -1;
            document.getElementById("nom").value = "";
            $("#listeJoueurs").text(data.nomsJoueurs);
         });

         socket.on('sortieAutreJoueur', data => {
            console.log("Le serveur confirme la sortie de "+data.nomJoueur);   
            numJoueur = data.numJoueur;
            $("#listeJoueurs").text(data.nomsJoueurs);
         });

         socket.on('messageServeur', message => {
            console.log("Message serveur : ", message);
            $("#messageServeur").text(message); 
         });

         socket.on('partie', joueurs =>{
            colorationTerrain(joueurs.length);
            document.getElementById("tablier").style.display = "inline";
         });
         
      </script>
  </head>
  <body>
      <div id ="joueurs">
         Joueurs : <label id="listeJoueurs"></label><br><br/>
         Votre nom <input id="nom" type="text" />
         <br><br>
         <div id="infosCreateur">
            Nombre de joueurs : <input type="number" name="nbJoueurs" id="nbJoueurs" min="1" max="4">
            <br><br>
            Nombre de tours : <input type="number" name="nbTours" id="nbTours" min="1" max="500">
            <br><br>
         </div>
         Répartissez 9 points entre Reproduction, Perception et Force.
         <span id="tousRépartis"><br><br>Vous avez dépassé le nombre maximal de points !</span>
         <br><br>
         Reproduction :
         <br>
         <div id="axe">
            <input type="range" class="slider" id="reproduction" name="reproduction" min="1" max="5" step="1" value="1"><br>
            <div id="graduation">
               <span>1</span>
               <span>2</span>
               <span>3</span>
               <span>4</span>
               <span>5</span>
            </div>
         </div>
         <br>
         Perception :
         <br>
         <div id="axe">
            <input type="range" class="slider" id="perception" name="perception" min="1" max="5" step="1" value="1"><br>
            <div id="graduation">
               <span>1</span>
               <span>2</span>
               <span>3</span>
               <span>4</span>
               <span>5</span>
            </div>
         </div>
         <br>
         Force :
         <br>
         <div id="axe">
            <input type="range" class="slider" id="force" name="force" min="1" max="5" step="1" value="1"><br>
            <div id="graduation">
               <span>1</span>
               <span>2</span>
               <span>3</span>
               <span>4</span>
               <span>5</span>
            </div>
         </div>
         <br>
         <button type="button" id="creerLaPartie" onClick="creerLaPartie()">Créer la partie</button>
         <button type="button" id="entrerDansLaPartie" onClick="entrerDansLaPartie()">Entrer dans la partie</button>
         <button type="button" id="quitterLaPartie" onClick="quitterLaPartie()">Quitter la partie</button> <br/>
      </div>
      <hr/>
      Message du serveur : <label id="messageServeur"></label>
      <hr/>
         <svg id="tablier" width="1200" height="1200"></svg>
  </body>
</html>